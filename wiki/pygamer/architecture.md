## MCU Architecture Diagram

![Diagram](https://raw.githubusercontent.com/shazz/MicroPython-CircuitPython-Experiments/master/wiki/images/pygamer/diagram.png)

## Details

### Clocks

#### Oscillators

 * `XOSC32K`: 32.768 kHz crystal oscillator
 * `XOSC`: Up to two 8 MHz to 48 MHz crystal oscillator
 * `OSCULP32K`: 32.768 kHz ultra low-power internal oscillator
 * `DFLL48M`: 48 MHz Digital Frequency Locked Loop
 * `FDPLL200M`: Two 96-200 MHz (output frequency) Fractional Digital Phased Locked Loop, from a 32 kHz to 3.2 MHz reference clock

#### Diagram

![Diagram](https://raw.githubusercontent.com/shazz/MicroPython-CircuitPython-Experiments/master/wiki/images/pygamer/samd51_clks.png)

Source: [clocks.c](https://github.com/adafruit/samd-peripherals/blob/83a4759d186574d8034435cd2303def85e4ed793/samd/samd51/clocks.c)

 * Clock sources controlled by `OSCCTRL` and `OSC32KCTRL`
 * Generic Clock Controller `GCLK`:
   * Generic Clock Generators: `0` (`GCLK_MAIN`) generates the clock signal `GCLK_MAIN`, which is used by the Power Manager and the Main Clock (`MCLK`)
   * Generic Clocks: These are clock signals generated by Generic Clock Generators and output by the Peripheral Channels, and serve as clocks for the peripherals of the system, Generic Clock `0` serves as the clock source for the `DFLL48M` clock input
 * Main Clock Controller (`MCLK`): This includes the `CPU`, bus clocks (`APB`, `AHB`) as well as the synchronous (to the `CPU`) user interfaces of the peripherals  
   
[hpl_gclk_config.h](https://github.com/adafruit/circuitpython/blob/master/ports/atmel-samd/asf4_conf/samd51/hpl_gclk_config.h)  : 
````C
// <h> Generic Clock Generator Control
// <y> Generic clock generator 0 source
// <GCLK_GENCTRL_SRC_XOSC0"> External Crystal Oscillator 8-48MHz (XOSC0)
// <GCLK_GENCTRL_SRC_XOSC1"> External Crystal Oscillator 8-48MHz (XOSC1)
// <GCLK_GENCTRL_SRC_GCLKIN"> Generic clock generator input pad
// <GCLK_GENCTRL_SRC_GCLKGEN1"> Generic clock generator 1
// <GCLK_GENCTRL_SRC_OSCULP32K"> 32kHz Ultra Low Power Internal Oscillator (OSCULP32K)
// <GCLK_GENCTRL_SRC_XOSC32K"> 32kHz External Crystal Oscillator (XOSC32K)
// <GCLK_GENCTRL_SRC_DFLL"> Digital Frequency Locked Loop (DFLL48M)
// <GCLK_GENCTRL_SRC_DPLL0"> Digital Phase Locked Loop (DPLL0)
// <GCLK_GENCTRL_SRC_DPLL1"> Digital Phase Locked Loop (DPLL1)

#ifndef CONF_GCLK_GEN_0_SOURCE
#define CONF_GCLK_GEN_0_SOURCE GCLK_GENCTRL_SRC_DPLL0
#endif
````

#### MCLK

![Diagram](https://raw.githubusercontent.com/shazz/MicroPython-CircuitPython-Experiments/master/wiki/images/pygamer/mclk.png)

[hpl_mclk_config.h](https://github.com/adafruit/circuitpython/blob/master/ports/atmel-samd/asf4_conf/samd51/hpl_mclk_config.h)
````C
// CPU Clock source: <GCLK_PCHCTRL_GEN_GCLK0_Val"> Generic clock generator 0
#define CONF_CPU_SRC GCLK_PCHCTRL_GEN_GCLK0_Val

// <i> Prescalar for CPU clock
// <MCLK_CPUDIV_DIV_DIV1_Val"> 1
#define CONF_MCLK_CPUDIV MCLK_CPUDIV_DIV_DIV1_Val
````

Generic Clock Generator 0 is defined with:
 * DPLL0 as source
 * DIVision factor  = 1
 * DIVide SELection = 0
 * output enabled and generator enabled
````C
/* -------- GCLK_GENCTRL : (GCLK Offset: 0x20) (R/W 32) Generic Clock Generator Control -------- */
#if !(defined(__ASSEMBLY__) || defined(__IAR_SYSTEMS_ASM__))
typedef union {
  struct {
    uint32_t SRC:4;            /*!< bit:  0.. 3  Source Select                      */
    uint32_t :4;               /*!< bit:  4.. 7  Reserved                           */
    uint32_t GENEN:1;          /*!< bit:      8  Generic Clock Generator Enable     */
    uint32_t IDC:1;            /*!< bit:      9  Improve Duty Cycle                 */
    uint32_t OOV:1;            /*!< bit:     10  Output Off Value                   */
    uint32_t OE:1;             /*!< bit:     11  Output Enable                      */
    uint32_t DIVSEL:1;         /*!< bit:     12  Divide Selection                   */
    uint32_t RUNSTDBY:1;       /*!< bit:     13  Run in Standby                     */
    uint32_t :2;               /*!< bit: 14..15  Reserved                           */
    uint32_t DIV:16;           /*!< bit: 16..31  Division Factor                    */
  } bit;                       /*!< Structure used for bit  access                  */
  uint32_t reg;                /*!< Type      used for register access              */
} GCLK_GENCTRL_Type;
#endif /* !(defined(__ASSEMBLY__) || defined(__IAR_SYSTEMS_ASM__)) */

#define CONF_FDPLL0_GCLK GCLK_PCHCTRL_GEN_GCLK5_Val

# set Generic Clock Generator Control 0 which generates GCLK_MAIN
GCLK->GENCTRL[0].reg = GCLK_GENCTRL_SRC(GCLK_GENCTRL_SRC_DPLL0_Val=0x7) | 
                       GCLK_GENCTRL_DIV(1)=1<<16 | 
                       divsel=0 | 
                       GCLK_GENCTRL_OE | 
                       GCLK_GENCTRL_GENEN;
````    

#### GCLKn

Set Generic Clock Generators:
 * `0`: source: `DPLL0`, divisor: `1`
 * `1`: source: `DFLL`, divisor: `1`
 * `4`: source: `DPLL0`, divisor: `1`
 * `5`: source: `DFLL`, divisor: `24`. The Digital Frequency-Locked Loop (`DFLL48M`) has a 48 MHz output frequency

````C
void clock_init(void) {
    // DFLL48M is enabled by default

    init_clock_source_osculp32k();

    // RTC ?
    OSC32KCTRL->RTCCTRL.bit.RTCSEL = OSC32KCTRL_RTCCTRL_RTCSEL_ULP1K_Val;
  
    // CPU Clock Division Factor = 1
    MCLK->CPUDIV.reg = MCLK_CPUDIV_DIV(1);

    // Set generic clock generators
    enable_clock_generator_sync(0, GCLK_GENCTRL_SRC_DPLL0_Val, 1, false);
    enable_clock_generator_sync(1, GCLK_GENCTRL_SRC_DFLL_Val, 1, false);
    enable_clock_generator_sync(4, GCLK_GENCTRL_SRC_DPLL0_Val, 1, false);
    enable_clock_generator_sync(5, GCLK_GENCTRL_SRC_DFLL_Val, 24, false);

    init_clock_source_dpll0();

    // Do this after all static clock init so that they aren't used dynamically.
    init_dynamic_clocks();
}
````

#### DPLL

![Diagram](https://raw.githubusercontent.com/shazz/MicroPython-CircuitPython-Experiments/master/wiki/images/pygamer/dpll.png)

`DPLL 0` init: `CLK_DPLL0 = CKR * (LDR + 1 + (LDRFRAC/32))` with
 * `CKR` = `GCLK_DPLL0` set to `GCLK_PCHCTRL_GEN_GCLK5_Val` means 48Mhz/24 = 2Mhz
 * `LDR` = 59
 * `LDRFRAC` = 0
 => `DPLL0` = 2 * 60 = 120 Mhz

````
static void init_clock_source_dpll0(void)
{
    // ctrl = enable | 5
    GCLK->PCHCTRL[OSCCTRL_GCLK_ID_FDPLL0].reg = GCLK_PCHCTRL_CHEN | GCLK_PCHCTRL_GEN(5);
    
    // loop divider to 59
    OSCCTRL->Dpll[0].DPLLRATIO.reg = OSCCTRL_DPLLRATIO_LDRFRAC(0) | OSCCTRL_DPLLRATIO_LDR(59);
    
    // Proportional Integral Filter Selection refclock set by GCLK
    OSCCTRL->Dpll[0].DPLLCTRLB.reg = OSCCTRL_DPLLCTRLB_REFCLK(0);
    OSCCTRL->Dpll[0].DPLLCTRLA.reg = OSCCTRL_DPLLCTRLA_ENABLE;

    while (!(OSCCTRL->Dpll[0].DPLLSTATUS.bit.LOCK || OSCCTRL->Dpll[0].DPLLSTATUS.bit.CLKRDY)) {}
}
````
